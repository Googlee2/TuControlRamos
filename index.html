<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>TuControlRamos â€“ Cargador de Datos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#dff3ff;
  margin:0;
}
.container{
  max-width:1200px;
  margin:30px auto;
  background:#fff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}
h2{text-align:center}
input,select,button{
  width:100%;
  padding:10px;
  margin:6px 0;
}
button{
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.green{background:#2ecc71;color:#fff}
.red{background:#e74c3c;color:#fff}
.hidden{display:none}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px
}
th,td{
  border:1px solid #ccc;
  padding:8px;
  text-align:center
}

.progress{
  width:100%;
  height:22px;
  background:#ddd;
  border-radius:12px;
  overflow:hidden;
  margin:10px 0;
}
.progress div{
  height:100%;
  width:0%;
  transition:.3s;
}

img.preview{
  max-width:120px;
  max-height:90px;
  border-radius:6px;
  border:1px solid #ccc;
  object-fit:contain;
}
.small-btn{
  padding:6px 10px;
  width:auto;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <h2>Ingreso</h2>
  <select id="tipo">
    <option value="admin">Administrador</option>
    <option value="empresa">Empresa</option>
  </select>
  <input id="user" placeholder="Usuario">
  <input id="pass" type="password" placeholder="ContraseÃ±a">
  <button class="green" onclick="login()">Ingresar</button>
</div>

<!-- ADMIN -->
<div class="container hidden" id="adminBox">
  <h2>Panel Administrador</h2>

  <h3>Crear empresa</h3>
  <input id="newEmpresa" placeholder="Usuario empresa">
  <input id="newPass" placeholder="ContraseÃ±a empresa">
  <button class="green" onclick="crearEmpresa()">Crear empresa</button>

  <h3>Archivos cargados</h3>
  <table>
    <thead>
      <tr>
        <th>Empresa</th>
        <th>Archivo</th>
        <th>Tipo</th>
        <th>TamaÃ±o (MB)</th>
        <th>Vista</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaAdmin"></tbody>
  </table>

  <button class="red" onclick="resetTodo()">RESET TOTAL</button>
  <button onclick="logout()">Salir</button>
</div>

<!-- EMPRESA -->
<div class="container hidden" id="empresaBox">
  <h2 id="empresaTitulo"></h2>

  <input type="file" id="file" multiple accept="image/*">
  <button class="green" onclick="subir()">Subir archivos</button>

  <p><b>Uso de espacio (mÃ¡x 1 GB)</b></p>
  <div class="progress"><div id="barra"></div></div>
  <p id="usoTexto"></p>

  <h3>Mis archivos</h3>
  <table>
    <thead>
      <tr>
        <th>Archivo</th>
        <th>Tipo</th>
        <th>TamaÃ±o (MB)</th>
        <th>Vista</th>
      </tr>
    </thead>
    <tbody id="tablaEmpresa"></tbody>
  </table>

  <button onclick="logout()">Salir</button>
</div>

<!-- VISOR -->
<div id="visor"
     style="display:none;
     position:fixed;
     inset:0;
     background:rgba(0,0,0,.85);
     z-index:9999;
     justify-content:center;
     align-items:center;"
     onclick="cerrarVisor()">
  <img id="visorImg"
       style="max-width:90%;
       max-height:90%;
       border-radius:10px;
       box-shadow:0 0 25px #000">
</div>

<script>
/* =============================
   CONFIG + DEMO AUTOMÃTICA
============================= */
const LIMITE = 1024 * 1024 * 1024;
let usuarioActual = null;

// Empresa demo automÃ¡tica (PC y celular)
(function(){
  const e = JSON.parse(localStorage.getItem("empresas") || "{}");
  if(Object.keys(e).length === 0){
    e["empresa"] = { pass:"1234" };
    localStorage.setItem("empresas", JSON.stringify(e));
  }
})();

const getEmpresas = () => JSON.parse(localStorage.getItem("empresas") || "{}");
const saveEmpresas = d => localStorage.setItem("empresas", JSON.stringify(d));
const getArchivos = () => JSON.parse(localStorage.getItem("archivos") || "{}");
const saveArchivos = d => localStorage.setItem("archivos", JSON.stringify(d));

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = e => reject(e);
    reader.readAsDataURL(file);
  });
}

/* =============================
   LOGIN
============================= */
function login(){
  const t = tipo.value;
  const u = user.value.trim();
  const p = pass.value.trim();

  if(t === "admin"){
    if(u === "admin" && p === "colgate"){
      loginBox.classList.add("hidden");
      adminBox.classList.remove("hidden");
      renderAdmin();
    } else alert("Credenciales incorrectas");
  } else {
    const e = getEmpresas();
    if(e[u] && e[u].pass === p){
      usuarioActual = u;
      loginBox.classList.add("hidden");
      empresaBox.classList.remove("hidden");
      empresaTitulo.innerText = "Empresa: " + u;
      renderEmpresa();
    } else alert("Credenciales incorrectas");
  }
}

function logout(){ location.reload(); }

/* =============================
   ADMIN
============================= */
function crearEmpresa(){
  const u = newEmpresa.value.trim();
  const p = newPass.value.trim();
  if(!u || !p) return alert("Datos incompletos");
  const e = getEmpresas();
  e[u] = { pass:p };
  saveEmpresas(e);
  alert("Empresa creada");
  newEmpresa.value = newPass.value = "";
}

function borrarArchivo(emp, index){
  if(!confirm("Â¿Eliminar archivo?")) return;
  const a = getArchivos();
  a[emp].splice(index,1);
  saveArchivos(a);
  renderAdmin();
}

function renderAdmin(){
  const a = getArchivos();
  tablaAdmin.innerHTML = "";

  for(let emp in a){
    a[emp].forEach((f,i)=>{
      let vista = f.preview
        ? `<img src="${f.preview}" class="preview" onclick="verImagen('${f.preview}')">`
        : "â€”";

      tablaAdmin.innerHTML += `
      <tr>
        <td>${emp}</td>
        <td>${f.name}</td>
        <td>${f.type}</td>
        <td>${(f.size/1024/1024).toFixed(2)}</td>
        <td>${vista}</td>
        <td>
          <button class="red small-btn"
            onclick="borrarArchivo('${emp}',${i})">ðŸ—‘</button>
        </td>
      </tr>`;
    });
  }
}

/* =============================
   EMPRESA (FIX CELULAR)
============================= */
async function subir(){
  const files = file.files;
  if(!files.length) return;

  const a = getArchivos();
  if(!a[usuarioActual]) a[usuarioActual] = [];

  let usado = a[usuarioActual].reduce((s,f)=>s+f.size,0);

  for(let f of files){

    // ðŸš« FIX: lÃ­mite real para celular
    if(f.size > 2 * 1024 * 1024){
      alert("En celulares solo se permiten imÃ¡genes de hasta 2 MB");
      continue;
    }

    if(usado + f.size > LIMITE){
      alert("LÃ­mite de 1 GB alcanzado");
      break;
    }

    let preview = null;
    if(f.type.startsWith("image/")){
      preview = await fileToBase64(f);
    }

    a[usuarioActual].push({
      name: f.name,
      type: f.type,
      size: f.size,
      preview: preview
    });

    usado += f.size;
  }

  saveArchivos(a);
  renderEmpresa();
}

function renderEmpresa(){
  const a = getArchivos()[usuarioActual] || [];
  tablaEmpresa.innerHTML = "";
  let total = 0;

  a.forEach(f=>{
    total += f.size;
    let vista = f.preview
      ? `<img src="${f.preview}" class="preview" onclick="verImagen('${f.preview}')">`
      : "â€”";

    tablaEmpresa.innerHTML += `
    <tr>
      <td>${f.name}</td>
      <td>${f.type}</td>
      <td>${(f.size/1024/1024).toFixed(2)}</td>
      <td>${vista}</td>
    </tr>`;
  });

  const p = (total / LIMITE) * 100;
  barra.style.width = p + "%";
  barra.style.background = p>90 ? "red" : p>70 ? "orange" : "green";
  usoTexto.innerText =
    (total/1024/1024).toFixed(2) + " MB usados de 1024 MB";
}

/* =============================
   VISOR + RESET
============================= */
function verImagen(src){
  visorImg.src = src;
  visor.style.display = "flex";
}
function cerrarVisor(){
  visor.style.display = "none";
  visorImg.src = "";
}

function resetTodo(){
  if(confirm("Â¿Borrar TODO el sistema?")){
    localStorage.clear();
    location.reload();
  }
}
</script>

</body>
</html>
