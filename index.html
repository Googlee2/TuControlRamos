<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TuControlRamos - Gestor Optimizado</title>
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f3f4f6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #e5e7eb;
            margin: 0; padding: 10px;
            display: flex; justify-content: center;
            min-height: 100vh; box-sizing: border-box;
        }

        .card {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%; max-width: 500px; margin: auto;
        }

        .hidden { display: none !important; }

        /* Login */
        .login-box { text-align: center; }
        input, select, button {
            width: 100%; padding: 12px; margin: 8px 0;
            border-radius: 10px; border: 1px solid #ccc; font-size: 16px;
        }
        button { background: var(--primary); color: white; font-weight: bold; border: none; cursor: pointer; }

        /* Paneles */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        /* Galería */
        .grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;
        }

        .item {
            background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 5px; text-align: center;
        }

        .item img {
            width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer;
        }

        .item-name { font-size: 11px; font-weight: bold; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Visor Full */
        #visor {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); display: none;
            justify-content: center; align-items: center; z-index: 999;
        }
        #visor img { max-width: 95%; max-height: 80%; border-radius: 10px; }

        /* Admin Table */
        .admin-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-bottom: 15px; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 8px; }
    </style>
</head>
<body>

<div id="visor" onclick="this.style.display='none'">
    <img id="imgFull" src="">
</div>

<div class="card login-box" id="login">
    <h2 style="color:var(--primary)">TuControlRamos</h2>
    <input type="text" id="u" placeholder="Usuario">
    <input type="password" id="p" placeholder="Contraseña">
    <button onclick="acceder()">ENTRAR</button>
    <p id="err" style="color:red; font-size:12px;"></p>
</div>

<div class="card hidden" id="pEmpresa">
    <div class="header">
        <h3 id="nomEmp">Empresa</h3>
        <button onclick="salir()" style="width:auto; background:var(--danger); padding:5px 10px;">X</button>
    </div>
    
    <div style="background:#f9f9f9; padding:10px; border-radius:10px;">
        <select id="folder">
            <option value="imag">Carpeta: imag/</option>
            <option value="read">Carpeta: read/</option>
        </select>
        <input type="file" id="file" accept="image/*">
        <button onclick="procesarSubida()" style="background:var(--success)">SUBIR FOTO</button>
        <p id="status" style="font-size:10px; color:blue;"></p>
    </div>

    <h4>Mis Archivos</h4>
    <div class="grid" id="gridEmp"></div>
</div>

<div class="card hidden" id="pAdmin" style="max-width: 700px;">
    <div class="header">
        <h3>Admin Maestro</h3>
        <button onclick="salir()" style="width:auto; background:var(--danger); padding:5px 10px;">Salir</button>
    </div>

    <table class="admin-table">
        <thead>
            <tr><th>Rol</th><th>Usuario</th><th>Clave</th><th></th></tr>
        </thead>
        <tbody id="userTable"></tbody>
    </table>

    <h4>Archivos Cargados</h4>
    <div class="grid" id="gridAdm"></div>
</div>

<script>
    // Config inicial
    if (!localStorage.getItem('TCR_C')) {
        localStorage.setItem('TCR_C', JSON.stringify({
            admin: { u: "admin", p: "colgate" },
            empresa: { u: "empresa35", p: "flac" }
        }));
    }

    function acceder() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        const c = JSON.parse(localStorage.getItem('TCR_C'));

        if (u === c.admin.u && p === c.admin.p) {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('pAdmin').classList.remove('hidden');
            renderUsers();
            renderFiles('admin');
        } else if (u === c.empresa.u && p === c.empresa.p) {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('pEmpresa').classList.remove('hidden');
            document.getElementById('nomEmp').textContent = u;
            renderFiles('empresa');
        } else {
            document.getElementById('err').textContent = "Error de acceso";
        }
    }

    function renderUsers() {
        const c = JSON.parse(localStorage.getItem('TCR_C'));
        document.getElementById('userTable').innerHTML = `
            <tr><td>Admin</td><td><input id="au" value="${c.admin.u}"></td><td><input id="ap" value="${c.admin.p}"></td><td><button onclick="saveC('admin')">V</button></td></tr>
            <tr><td>Empr</td><td><input id="eu" value="${c.empresa.u}"></td><td><input id="ep" value="${c.empresa.p}"></td><td><button onclick="saveC('empresa')">V</button></td></tr>
        `;
    }

    function saveC(t) {
        const c = JSON.parse(localStorage.getItem('TCR_C'));
        if(t === 'admin'){ c.admin.u = document.getElementById('au').value; c.admin.p = document.getElementById('ap').value; }
        else { c.empresa.u = document.getElementById('eu').value; c.empresa.p = document.getElementById('ep').value; }
        localStorage.setItem('TCR_C', JSON.stringify(c));
        alert("Cambiado");
    }

    // COMPRESOR DE IMAGEN (Soluciona el problema de carga)
    function procesarSubida() {
        const file = document.getElementById('file').files[0];
        const status = document.getElementById('status');
        if(!file) return alert("Elige una imagen");

        status.textContent = "Procesando...";

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800; // Reducimos para que quepan muchas fotos
                const scale = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scale;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // Comprimimos al 60% de calidad
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                
                guardarEnDB(file.name, dataUrl);
            };
        };
    }

    function guardarEnDB(nombre, data) {
        const db = JSON.parse(localStorage.getItem('TCR_F') || '[]');
        db.push({
            id: Date.now(),
            n: nombre,
            f: document.getElementById('folder').value,
            d: data
        });
        localStorage.setItem('TCR_F', JSON.stringify(db));
        document.getElementById('status').textContent = "¡Cargado!";
        document.getElementById('file').value = "";
        renderFiles('empresa');
    }

    function renderFiles(role) {
        const g = document.getElementById(role === 'empresa' ? 'gridEmp' : 'gridAdm');
        const db = JSON.parse(localStorage.getItem('TCR_F') || '[]');
        g.innerHTML = '';

        db.forEach(i => {
            const card = document.createElement('div');
            card.className = 'item';
            card.innerHTML = `
                <img src="${i.d}" onclick="verFull('${i.d}')">
                <div class="item-name">${i.n}</div>
                <div style="font-size:9px; color:gray">/${i.f}</div>
            `;
            if(role === 'admin') {
                const btn = document.createElement('button');
                btn.textContent = "Borrar";
                btn.style = "background:red; font-size:10px; margin-top:5px; height:25px;";
                btn.onclick = () => {
                    let newDb = JSON.parse(localStorage.getItem('TCR_F')).filter(x => x.id !== i.id);
                    localStorage.setItem('TCR_F', JSON.stringify(newDb));
                    renderFiles('admin');
                };
                card.appendChild(btn);
            }
            g.appendChild(card);
        });
    }

    function verFull(src) {
        document.getElementById('imgFull').src = src;
        document.getElementById('visor').style.display = 'flex';
    }

    function salir() { location.reload(); }
</script>
</body>
</html>
